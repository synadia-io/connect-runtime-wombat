model_version: "1"
kind: sink
label: Elasticsearch V8
name: elasticsearch_v8
icon: data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij4KICAgIDxwYXRoIGZpbGw9IiMzNDM3NDEiIGQ9Ik00IDY0YzAgNS41MzUuNzc3IDEwLjg3OSAyLjA5OCAxNkg4NGM4LjgzNiAwIDE2LTcuMTY0IDE2LTE2cy03LjE2NC0xNi0xNi0xNkg2LjA5OEE2My43MzggNjMuNzM4IDAgMCAwIDQgNjQiLz4KICAgIDxwYXRoIGZpbGw9IiNmZWM1MTQiIGQ9Ik0xMTEuNjk1IDMwLjY0OEE2MS40ODUgNjEuNDg1IDAgMCAwIDExNy45MjIgMjRDMTA2LjE4OCA5LjM3OSA4OC4xOTkgMCA2OCAwIDQyLjcxNSAwIDIwLjk1NyAxNC43MSAxMC41NzQgMzZIOTguMDRhMjAuMTIzIDIwLjEyMyAwIDAgMCAxMy42NTItNS4zNTIiLz4KICAgIDxwYXRoIGZpbGw9IiMwMGJmYjMiIGQ9Ik05OC4wNCA5MkgxMC41NzdDMjAuOTYxIDExMy4yOSA0Mi43MTUgMTI4IDY4IDEyOGMyMC4yIDAgMzguMTg4LTkuMzgzIDQ5LjkyMi0yNGE2MS4xIDYxLjEgMCAwIDAtNi4yMjctNi42NDhBMjAuMTMzIDIwLjEzMyAwIDAgMCA5OC4wNCA5MiIvPgo8L3N2Zz4K
status: experimental
description: |
    Publishes messages into an Elasticsearch index. If the index does not exist then it is created with a dynamic mapping.

    Both the `id` and `index` fields can be dynamically set using function interpolations described xref:configuration:interpolation.adoc#bloblang-queries[here]. When sending batched messages these interpolations are performed per message part.

    # Performance

    This output benefits from sending multiple messages in flight in parallel for improved performance. You can tune the max number of in flight messages (or message batches) with the field `max_in_flight`.

    This output benefits from sending messages as a batch for improved performance. Batches can be formed at both the input and output level. You can find out more xref:configuration:batching.adoc[in this doc].
fields:
    - path: urls
      name: urls
      label: urls
      kind: list
      type: string
      description: A list of URLs to connect to. If an item of the list contains commas it will be expanded into multiple URLs.
      examples:
        - - http://localhost:9200
    - path: index
      name: index
      label: index
      kind: scalar
      type: string
      description: The index to place messages.
    - path: action
      name: action
      label: action
      kind: scalar
      type: string
      constraints:
        - enum:
            - index
            - update
            - delete
            - create
            - upsert
      description: 'The action to take on the document. This field must resolve to one of the following action types: `index`, `update`, `delete`, `create` or `upsert`. See the `Updating Documents` example for more on how the `update` action works and the `Create Documents` and `Upserting Documents` examples for how to use the `create` and `upsert` actions respectively.'
    - path: id
      name: id
      label: id
      kind: scalar
      type: string
      description: The ID for indexed messages. Interpolation should be used in order to create a unique ID for each message.
      examples:
        - ${!counter()}-${!timestamp_unix()}
    - path: pipeline
      name: pipeline
      label: pipeline
      kind: scalar
      type: string
      optional: true
      default: ""
      description: An optional pipeline id to preprocess incoming documents.
    - path: routing
      name: routing
      label: routing
      kind: scalar
      type: string
      optional: true
      default: ""
      description: The routing key to use for the document.
    - path: retry_on_conflict
      name: retry_on_conflict
      label: retry_on_conflict
      kind: scalar
      type: int
      optional: true
      default: 0
      description: Specify how many times should an update operation be retried when a conflict occurs
    - path: tls
      name: tls
      label: tls
      kind: scalar
      type: object
      optional: true
      default: {}
      description: Custom TLS settings can be used to override system defaults.
      fields:
        - path: tls.enabled
          name: enabled
          label: enabled
          kind: scalar
          type: bool
          optional: true
          default: false
          description: Whether custom TLS settings are enabled.
        - path: tls.skip_cert_verify
          name: skip_cert_verify
          label: skip_cert_verify
          kind: scalar
          type: bool
          optional: true
          default: false
          description: Whether to skip server side certificate verification.
        - path: tls.enable_renegotiation
          name: enable_renegotiation
          label: enable_renegotiation
          kind: scalar
          type: bool
          optional: true
          default: false
          description: 'Whether to allow the remote server to repeatedly request renegotiation. Enable this option if you''re seeing the error message `local error: tls: no renegotiation`.'
        - path: tls.root_cas
          name: root_cas
          label: root_cas
          kind: scalar
          type: string
          optional: true
          default: ""
          description: An optional root certificate authority to use. This is a string, representing a certificate chain from the parent trusted root certificate, to possible intermediate signing certificates, to the host certificate.
          secret: true
          examples:
            - |-
              -----BEGIN CERTIFICATE-----
              ...
              -----END CERTIFICATE-----
        - path: tls.root_cas_file
          name: root_cas_file
          label: root_cas_file
          kind: scalar
          type: string
          optional: true
          default: ""
          description: An optional path of a root certificate authority file to use. This is a file, often with a .pem extension, containing a certificate chain from the parent trusted root certificate, to possible intermediate signing certificates, to the host certificate.
          examples:
            - ./root_cas.pem
        - path: tls.client_certs
          name: client_certs
          label: client_certs
          kind: list
          type: object
          optional: true
          default: []
          description: A list of client certificates to use. For each certificate either the fields `cert` and `key`, or `cert_file` and `key_file` should be specified, but not both.
          examples:
            - - cert: foo
                key: bar
            - - cert_file: ./example.pem
                key_file: ./example.key
          fields:
            - path: tls.client_certs[].cert
              name: cert
              label: cert
              kind: scalar
              type: string
              optional: true
              default: ""
              description: A plain text certificate to use.
            - path: tls.client_certs[].key
              name: key
              label: key
              kind: scalar
              type: string
              optional: true
              default: ""
              description: A plain text certificate key to use.
              secret: true
            - path: tls.client_certs[].cert_file
              name: cert_file
              label: cert_file
              kind: scalar
              type: string
              optional: true
              default: ""
              description: The path of a certificate to use.
            - path: tls.client_certs[].key_file
              name: key_file
              label: key_file
              kind: scalar
              type: string
              optional: true
              default: ""
              description: The path of a certificate key to use.
            - path: tls.client_certs[].password
              name: password
              label: password
              kind: scalar
              type: string
              optional: true
              default: ""
              description: |-
                A plain text password for when the private key is password encrypted in PKCS#1 or PKCS#8 format. The obsolete `pbeWithMD5AndDES-CBC` algorithm is not supported for the PKCS#8 format.

                Because the obsolete pbeWithMD5AndDES-CBC algorithm does not authenticate the ciphertext, it is vulnerable to padding oracle attacks that can let an attacker recover the plaintext.
              secret: true
              examples:
                - foo
                - ${KEY_PASSWORD}
    - path: max_in_flight
      name: max_in_flight
      label: max_in_flight
      kind: scalar
      type: int
      default: 64
      description: The maximum number of messages to have in flight at a given time. Increase this to improve throughput.
    - path: basic_auth
      name: basic_auth
      label: basic_auth
      kind: scalar
      type: object
      optional: true
      default: { }
      description: Allows you to specify basic authentication.
      fields:
        - path: basic_auth.enabled
          name: enabled
          label: enabled
          kind: scalar
          type: bool
          optional: true
          default: false
          description: Whether to use basic authentication in requests.
        - path: basic_auth.username
          name: username
          label: username
          kind: scalar
          type: string
          optional: true
          default: ""
          description: A username to authenticate as.
        - path: basic_auth.password
          name: password
          label: password
          kind: scalar
          type: string
          optional: true
          default: ""
          description: A password to authenticate with.
          secret: true
    - path: batching
      name: batching
      label: batching
      kind: scalar
      type: object
      optional: true
      default: {}
      description: Allows you to configure a xref:configuration:batching.adoc[batching policy].
      examples:
        - byte_size: 5000
          count: 0
          period: 1s
        - count: 10
          period: 1s
        - check: this.contains("END BATCH")
          count: 0
          period: 1m
      fields:
        - path: batching.count
          name: count
          label: count
          kind: scalar
          type: int
          optional: true
          default: 0
          description: A number of messages at which the batch should be flushed. If `0` disables count based batching.
        - path: batching.byte_size
          name: byte_size
          label: byte_size
          kind: scalar
          type: int
          optional: true
          default: 0
          description: An amount of bytes at which the batch should be flushed. If `0` disables size based batching.
        - path: batching.period
          name: period
          label: period
          kind: scalar
          type: string
          optional: true
          default: ""
          description: A period in which an incomplete batch should be flushed regardless of its size.
          examples:
            - 1s
            - 1m
            - 500ms
        - path: batching.check
          name: check
          label: check
          kind: scalar
          type: string
          optional: true
          default: ""
          description: A xref:guides:bloblang/about.adoc[Bloblang query] that should return a boolean value indicating whether a message should end a batch.
          examples:
            - this.type == "end_of_transaction"
        - path: batching.processors
          name: processors
          label: processors
          kind: list
          type: object
          optional: true
          default: {}
          description: A list of xref:components:processors/about.adoc[processors] to apply to a batch as it is flushed. This allows you to aggregate and archive the batch however you see fit. Please note that all resulting messages are flushed as a single batch, therefore splitting the batch into smaller batches using these processors is a no-op.
          examples:
            - - archive:
                    format: concatenate
            - - archive:
                    format: lines
            - - archive:
                    format: json_array
